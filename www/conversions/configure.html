<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Configurable Attribution</title>
  <meta http-equiv="origin-trial" content="AhLiKoJIb0AwsL4F4D36xJ7UmaUc/85N1Yk5yjDLxPAoI/TTSQ2jDYaPXeGhU4dt3Kp1doeVRZkbVzEiIsVQcQMAAABdeyJvcmlnaW4iOiJodHRwczovL2NyLmt1bmdmb28ubmV0OjQ0MyIsImZlYXR1cmUiOiJDb252ZXJzaW9uTWVhc3VyZW1lbnQiLCJleHBpcnkiOjE2MjYyMjA3OTl9">
<style>
body {
  font-family: Roboto, sans-serif;
  font-size: 13px;
}
fieldset > div {
  padding: 1em;
  box-sizing: border-box;
  display: grid;
  grid-template-columns: 1fr 1fr;
}
#imgs {
  display: none;
}
</style>
</head>
<body>
  <form>
    <fieldset>
      <legend>Source</legend>
      <div>
        <label for="sourceeventid">Event ID:</label><input id="sourceeventid">
        <label for="sourcepriority">Priority:</label><input id="sourcepriority">
        <label for="sourceexpiry">Expiry (days):</label><input id="sourceexpiry">
        <label><input id="registerattributionsource" type="checkbox">Register on View</label>
      </div>
      <button id="add-anchor" type="button">Add Anchor</button>
    </fieldset>
    <fieldset>
      <legend>Trigger</legend>
      <div>
        <label for="triggerdata">Trigger Data:</label><input id="triggerdata" value="2">
        <label for="eventsourcetriggerdata">Event-Source Trigger Data:</label><input id="eventsourcetriggerdata">
        <label for="triggerpriority">Priority:</label><input id="triggerpriority">
        <label for="dedupkey">Dedup Key:</label><input id="dedupkey">
        <label><input id="fetch" type="checkbox" checked>Use <code>window.fetch</code></label>
      </div>
      <button id="convert" type="button">Convert</button>
    </fieldset>
  </form>
  <h2>Anchors</h2>
  <ol id="anchors"></ol>
  <div id="imgs"></div>
</body>
<script>
  const vals = new Uint32Array(1);
  window.crypto.getRandomValues(vals);
  document.getElementById('sourceeventid').value = vals[0];

  document.getElementById('add-anchor').addEventListener('click', (e) => {
    const params = {
      'sourceeventid': document.getElementById('sourceeventid').value,
      'sourcepriority': document.getElementById('sourcepriority').value,
      'sourceexpiry': document.getElementById('sourceexpiry').value,
      'registerattributionsource': document.getElementById('registerattributionsource').checked,
    };

    const a = document.createElement('a');
    a.target = '_blank';
    a.href = window.location.origin;
    a.rel = 'opener';
    a.innerText = 'Register source with ' + JSON.stringify(params);

    if (params.sourceeventid !== '') {
        a.setAttribute('attributionsourceeventid',  params.sourceeventid);
    }

    if (params.sourcepriority !== '') {
      a.setAttribute('attributionsourcepriority', params.sourcepriority);
    }

    a.setAttribute('attributiondestination', window.location.origin);

    if (params.sourceexpiry !== '') {
      // Convert to milliseconds.
      a.setAttribute('attributionexpiry', params.sourceexpiry * 24 * 60 * 60 * 1000);
    }

    if (params.registerattributionsource) {
      a.setAttribute('registerattributionsource', '');
    }

    const li = document.createElement('li');
    li.appendChild(a);
    document.getElementById('anchors').appendChild(li);
  });

  document.getElementById('convert').addEventListener('click', (e) => {
    const triggerParams = new URLSearchParams();

    const setIfNotEmpty = (name, value) => {
      if (value !== '') {
        triggerParams.set(name, value);
      }
    };

    setIfNotEmpty('trigger-data', document.getElementById('triggerdata').value);
    setIfNotEmpty('event-source-trigger-data', document.getElementById('eventsourcetriggerdata').value);
    setIfNotEmpty('priority', document.getElementById('triggerpriority').value);
    setIfNotEmpty('dedup-key', document.getElementById('dedupkey').value);
    const url = 'configure_convert.php?' + triggerParams.toString();

    if (document.getElementById('fetch').checked) {
      window.fetch(url).then(console.log);
    } else {
      const img = document.createElement('img');
       img.src = url;
       document.getElementById('imgs').appendChild(img);
    }
  });
</script>
</html>
