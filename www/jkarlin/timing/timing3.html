  <!DOCTYPE html>
  <html>
  <head>
    <script src='plotly.js'></script>
    <script src='regression.js'></script>
  </head>

  <body>
  <p>This site times network requests from start to the load event firing for various
     known sizes of requests (10 times per size). It then downloads several randomly 
     sized resources (10 times each) and attempts to guess the size of the resource 
     based on the networking timing.</p>
    
    
  <div id="status">Gathering network samples...</div>
  <div id='log'></div>
  <div id="result"></div>
  <div id="guessPlot" style="width:900px;height:400px;"></div>  
  <div id="distPlot" style="width:900px;height:400px;"></div>   
    

    
  <script>
  function mean(data) {
    let sum = data.reduce(function(sum, value) { return sum + value; }, 0);

    return sum / data.length;
  }

  function median(d) {
    return percentile(d, 0.5);
  }

  function percentile(d, target) {
    let data = d.slice(0);  // clone d
    data.sort(function(a, b){return a - b});
    let count = 0;
    for (val of data) {
      count += 1;
      if ((count / d.length) >= target)
        return val;
    }
    return -1;
  }

  function standardDeviation(values) {
    let avg = mean(values);

    let squareDiffs = values.map(function(value) {
      let diff = value - avg;
      let sqrDiff = diff * diff;
      return sqrDiff;
    });

    let avgSquareDiff = mean(squareDiffs);

    let stdDev = Math.sqrt(avgSquareDiff);
    return stdDev;
  }

  function log(msg) {
    var small = document.createElement("small");
    small.appendChild(document.createTextNode(msg));
    document.getElementById("log").appendChild(small);
    document.getElementById("log").appendChild(document.createElement("br"));
  }

  // Creates a link rel=prefetch and times how long the resource load takes.
  async function timeResourceLoad(size) {
    var link = document.createElement('link');
    link.rel = "prefetch";

    return new Promise(function(resolve, reject) {
      let startTime = window.performance.now();
      link.onerror = function() {
        console.log("OnError");
        let endTime = window.performance.now();
        resolve(endTime - startTime);
      }
      link.onload = function() {
        let endTime = window.performance.now();
        resolve(endTime - startTime);
      }

      link.href =
          "https://cr2.kungfoo.net/jkarlin/timing/size.php?size=" + size;
      document.body.appendChild(link);
    });
  }

  async function guessSize(size) {
    let small = 1;
    let large = 1024 * 300;

    // Sample small
    let smallTime = await timeResourceLoad(small);
    // Sample unknown
    let unknownTime = await timeResourceLoad(size);
    // Sample large
    let largeTime = await timeResourceLoad(large);
    
    rangeTime = largeTime - smallTime;
    unRangeTime = unknownTime - smallTime;
    
    // Linear interpolation to guess size
    guess = unRangeTime / rangeTime * (large - small);

    return guess;
  }

  (async function() {
    let numGuesses = 10;
    let samplesPerGuess = 10;
    let deltas = [];
    let actualBytes = [];
    let guessedBytes = [];

    for (let i = 0; i < numGuesses; i++) {
      // Grab a sample to predict of random size
      let bytes = Math.floor(Math.random() * 1024 * 300);
      let guesses = [];
      for (let i = 0; i <= samplesPerGuess; i++) {
        let guess = await guessSize(bytes);
        guesses.push(guess);
      }
      let guess = median(guesses);
      deltaKB = Math.abs(guess - bytes) / 1024;
      deltas.push(deltaKB);
      actualBytes.push(bytes);
      guessedBytes.push(guess);
    }

    result = document.getElementById('result');
    resultMsg = "Median delta is " + Math.floor(median(deltas)) +
                "KB and 90th percentile delta is " + Math.floor(percentile(deltas, 0.9)) +
                'KB';
    result.appendChild(document.createTextNode(resultMsg));

    // Plot a scatter plot showing guessed vs actual
    plotDiv = document.getElementById('guessPlot');
    let scatterGuess = {
      x : actualBytes,
      y : guessedBytes,
      mode : 'markers',
      type : 'scatter',
      name : 'actual vs estimate'
    };
    let xEqualsY = {
      x : actualBytes,
      y : actualBytes,
      mode : 'lines',
      type : 'scatter',
      name : 'x=y'
    };
    Plotly.plot(plotDiv, [scatterGuess, xEqualsY], {
      xaxis : {
      title:
        'Actual'
      }
        , yaxis : {title : 'Predicted bytes'}, title : 'Predictions'
    });
  })();

  </script>
  </body>
